{% extends "base.html" %}
{% load static %}

{% block title %}Мои записи{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/my_bookings.css' %}">
{% endblock %}

{% block main_content %}
<div class="my-bookings-container">
  <h1>Мои записи</h1>

  <!-- Фильтр и поиск -->
  <div class="filter-bar">
    <input 
      type="text" 
      id="search-input" 
      placeholder="Поиск по клиенту или описанию проблемы..."
      title="Введите email клиента или фрагмент описания проблемы"
    >
    <select id="status-filter" title="Фильтр по статусу">
      <option value="">Все</option>
      <option value="pending">Ожидает подтверждения</option>
      <option value="confirmed">Подтверждено</option>
      <option value="canceled">Отменено</option>
      <option value="completed">Выполнено</option>
    </select>
    <button id="export-btn" class="btn btn-export">Экспорт в CSV</button>
  </div>

  {% if bookings %}
    <div id="bookingsCards">
      {% for booking in bookings %}
        <div class="booking-card"
             data-status="{{ booking.status }}"
             data-client="{{ booking.user.email|lower }}"
             data-problem="{{ booking.problem_description|default:''|lower }}">
          <h3>{{ booking.user.email }}</h3>
          <p><strong>Описание проблемы:</strong> {{ booking.problem_description|default:"—" }}</p>
          <p><strong>Предпочтительные интервалы:</strong> {{ booking.available_times|default:"—" }}</p>
          <p><strong>Дата создания:</strong> {{ booking.created_at|date:"d M Y H:i" }}</p>
          <p><strong>Статус:</strong> {{ booking.get_status_display }}</p>
          <div class="actions">
            {% if booking.status == "pending" %}
              <a href="{% url 'booking:confirm_booking' booking.id %}" class="btn btn-confirm">Подтвердить</a>
              <a href="{% url 'booking:handle_booking' booking.id 'decline' %}" class="btn btn-decline">Отклонить</a>
            {% elif booking.status == "confirmed" %}
              <p class="scheduled"><strong>Назначено:</strong> {{ booking.scheduled_time|date:"d M Y H:i" }}</p>
              <a href="{% url 'booking:handle_booking' booking.id 'complete' %}" class="btn btn-complete" title="Пометить как выполнено">Завершить</a>
            {% elif booking.status == "completed" %}
              <span class="completed">Выполнено</span>
            {% else %}
              {{ booking.get_status_display }}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="no-bookings">Нет входящих записей.</p>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchInput = document.getElementById("search-input");
  const statusFilter = document.getElementById("status-filter");
  const bookingCards = document.querySelectorAll("#bookingsCards .booking-card");
  const exportBtn = document.getElementById("export-btn");

  // Фильтрация карточек
  function filterCards() {
    const query = searchInput.value.toLowerCase().trim();
    const statusValue = statusFilter.value;

    bookingCards.forEach(card => {
      const cardStatus = card.getAttribute("data-status");
      const cardClient = card.getAttribute("data-client");
      const cardProblem = card.getAttribute("data-problem");

      const statusMatch = !statusValue || (cardStatus === statusValue);
      const searchMatch = cardClient.includes(query) || cardProblem.includes(query);

      card.style.display = (statusMatch && searchMatch) ? "" : "none";
    });
  }

  searchInput.addEventListener("input", filterCards);
  statusFilter.addEventListener("change", filterCards);

  // Экспорт в CSV
  exportBtn.addEventListener("click", function() {
    let csvContent = "data:text/csv;charset=utf-8," 
      + "Клиент;Описание;Интервалы;Дата создания;Статус\n";

    bookingCards.forEach(card => {
      if (card.style.display !== "none") {
        const client = card.getAttribute("data-client");
        const problem = card.getAttribute("data-problem");
        // Извлекаем текст из абзацев (предполагается фиксированный порядок)
        const paragraphs = card.querySelectorAll("p");
        const intervals = paragraphs[1].innerText.replace("Предпочтительные интервалы:", "").trim();
        const createdAt = paragraphs[2].innerText.replace("Дата создания:", "").trim();
        const status = paragraphs[3].innerText.replace("Статус:", "").trim();
        csvContent += [client, problem, intervals, createdAt, status].join(";") + "\n";
      }
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "bookings_export.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
});
</script>
{% endblock %}
