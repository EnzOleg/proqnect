{% extends "base.html" %}
{% load static %}

{% block title %}Мои записи{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/my_bookings.css' %}">
{% endblock %}

{% block main_content %}
<div class="my-bookings-container">
  <h1>Мои записи</h1>

  <!-- Фильтр и поиск -->
  <div class="filter-bar">
    <input 
      type="text" 
      id="search-input" 
      placeholder="Поиск по клиенту или описанию проблемы..."
      title="Введите email клиента или фрагмент описания проблемы"
    >
    <select id="status-filter" title="Фильтр по статусу">
      <option value="">Все</option>
      <option value="pending">Ожидает подтверждения</option>
      <option value="confirmed">Подтверждено</option>
      <option value="canceled">Отменено</option>
      <option value="completed">Выполнено</option>
    </select>
    <button id="export-btn" class="btn btn-export">Экспорт в CSV</button>
  </div>

  {% if bookings %}
    <table class="bookings-table" id="bookingsTable">
      <thead>
        <tr>
          <th>Клиент</th>
          <th>Описание проблемы</th>
          <th>Предпочтительные интервалы</th>
          <th>Дата создания</th>
          <th>Статус</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in bookings %}
          <tr 
            data-status="{{ booking.status }}" 
            data-client="{{ booking.user.email|lower }}" 
            data-problem="{{ booking.problem_description|default:''|lower }}"
          >
            <td>{{ booking.user.email }}</td>
            <td>{{ booking.problem_description|default:"—" }}</td>
            <td>{{ booking.available_times|default:"—" }}</td>
            <td>{{ booking.created_at|date:"d M Y H:i" }}</td>
            <td>{{ booking.get_status_display }}</td>
            <td>
              {% if booking.status == "pending" %}
                <div class="actions">
                  <a href="{% url 'booking:confirm_booking' booking.id %}" class="btn btn-confirm">Подтвердить</a>
                  <a href="{% url 'booking:handle_booking' booking.id 'decline' %}" class="btn btn-decline">Отклонить</a>
                </div>
              {% elif booking.status == "confirmed" %}
                <div class="actions">
                  <span class="scheduled">Назначено: {{ booking.scheduled_time|date:"d M Y H:i" }}</span>
                  <!-- Доп. функционал: Пометить как выполнено -->
                  <a 
                    href="{% url 'booking:handle_booking' booking.id 'complete' %}" 
                    class="btn btn-complete"
                    title="Пометить как выполнено"
                  >
                    Завершить
                  </a>
                </div>
              {% elif booking.status == "completed" %}
                <span class="completed">Выполнено</span>
              {% else %}
                {{ booking.get_status_display }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="no-bookings">Нет входящих записей.</p>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchInput = document.getElementById("search-input");
  const statusFilter = document.getElementById("status-filter");
  const tableRows = document.querySelectorAll("#bookingsTable tbody tr");
  const exportBtn = document.getElementById("export-btn");

  // Функция фильтрации по статусу и поиску
  function filterRows() {
    const query = searchInput.value.toLowerCase().trim();
    const statusValue = statusFilter.value;

    tableRows.forEach(row => {
      const rowStatus = row.getAttribute("data-status");
      const rowClient = row.getAttribute("data-client");
      const rowProblem = row.getAttribute("data-problem");

      // Проверка статуса
      const statusMatch = !statusValue || (rowStatus === statusValue);
      // Проверка поиска (email клиента или текст проблемы)
      const searchMatch =
        rowClient.includes(query) ||
        rowProblem.includes(query);

      // Если оба совпадают - показываем, иначе скрываем
      if (statusMatch && searchMatch) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }

  // Слушатели для поиска и фильтра
  searchInput.addEventListener("input", filterRows);
  statusFilter.addEventListener("change", filterRows);

  // Экспорт в CSV
  exportBtn.addEventListener("click", function() {
    let csvContent = "data:text/csv;charset=utf-8," 
      + "Клиент;Описание;Интервалы;Дата создания;Статус\n";

    tableRows.forEach(row => {
      if (row.style.display !== "none") {
        const cells = row.querySelectorAll("td");
        const rowData = [];
        cells.forEach((cell, idx) => {
          // Пропустим последний столбец "Действия" при экспорте
          if (idx < 5) {
            rowData.push(cell.innerText.replace(";", ","));
          }
        });
        csvContent += rowData.join(";") + "\n";
      }
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "bookings_export.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
});
</script>
{% endblock %}
