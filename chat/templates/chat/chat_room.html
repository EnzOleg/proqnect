{% extends "base.html" %}
{% load static %}

{% block title %}Чат с {{ chat_partner.name }} {{ chat_partner.last_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat_room.css' %}">
{% endblock %}

{% block main_content %}
<div class="main-wrapper">
    <div class="chat-container">
        <!-- Левая панель: список чатов -->
        <div class="chat-sidebar">
            <h2>Ваши чаты</h2>
            {% if sidebar %}
            <ul class="chat-list">
                {% for past_chat, partner in sidebar %}
                    <li class="chat-item {% if chat.id == past_chat.id %}active{% endif %}">
                        <a href="{% url 'chat:chat_room' past_chat.id %}">
                            <img src="{% if partner.profile_picture %}{{ partner.profile_picture.url }}{% else %}{% static 'avatars/def_icon.png' %}{% endif %}" class="chat-avatar" alt="Avatar">
                            <span>{{ partner.first_name }} {{ partner.last_name }}</span>
                        </a>
                    </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>

        <!-- Центральная панель: чат -->
        <div class="chat-main">
            <div class="chat-header">
                <img src="{% if chat_partner.profile_picture %}{{ chat_partner.profile_picture.url }}{% else %}{% static 'avatars/def_icon.png' %}{% endif %}" class="header-avatar" alt="Avatar">
                <h1><a href="{{ chat_partner.profile_url }}">{{ chat_partner.first_name }} {{ chat_partner.last_name }}</a></h1>
            </div>

            <div id="chat-messages" class="chat-messages">
                {% for message in chat.messages.all %}
                <div class="chat-message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                    <img src="{% if message.sender.profile_picture %}{{ message.sender.profile_picture.url }}{% else %}{% static 'avatars/def_icon.png' %}{% endif %}" class="message-avatar" alt="Avatar">
                    <div class="message-content">
                        <span class="message-sender">
                            <a href="{{ message.sender.profile_url }}">
                                {{ message.sender.first_name }} {{ message.sender.last_name }}
                            </a>
                        </span>                    
                        <span class="message-text">{{ message.text }}</span>
                        <span class="message-time">{{ message.timestamp|date:"H:i" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <form id="chat-form" method="post">
                {% csrf_token %}
                <input type="text" id="message-input" name="message" placeholder="Введите сообщение..." autocomplete="off">
                <button type="submit">&#9658;</button>
            </form>
        </div>
    </div>
</div>

<script>
    const chatId = "{{ chat.id }}";
    const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const wsUrl = `${wsProtocol}${window.location.host}/ws/chat/${chatId}/`;
    const chatMessages = document.getElementById('chat-messages');
    let chatSocket;

    function connectWebSocket() {
        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = () => console.log("✅ WebSocket открыт");

        chatSocket.onmessage = (e) => {
            console.log("Получено сообщение:", e.data);
            try {
                const data = JSON.parse(e.data);
                if (data.message) {
                    addMessageToChat(data);
                }
            } catch (error) {
                console.error("Ошибка парсинга JSON:", error);
            }
        };

        chatSocket.onclose = () => {
            console.warn("⚠️ WebSocket закрыт, пытаемся переподключиться...");
            setTimeout(connectWebSocket, 2000);
        };

        chatSocket.onerror = (error) => {
            console.error("WebSocket ошибка:", error);
        };
    }

    function addMessageToChat(data) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add(
            'chat-message',
            data.sender_id.toString() === "{{ request.user.id }}" ? 'sent' : 'received'
        );

        const timestamp = data.timestamp ? new Date(data.timestamp) : new Date();
        const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        messageDiv.innerHTML = `
            <img src="${data.avatar || "{% static 'avatars/def_icon.png' %}"}" class="message-avatar" alt="Avatar">
            <div class="message-content">
                <span class="message-sender"><a href="${data.profile_url || '#'}">${data.sender}</a></span>
                <span class="message-text">${data.message}</span>
                <span class="message-time">${timeString}</span>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    document.getElementById('chat-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const input = document.getElementById('message-input');
        if (!input.value.trim()) return;
        chatSocket.send(JSON.stringify({ message: input.value }));
        input.value = '';
    });

    window.onload = function() {
        var chatContainer = document.getElementById('chat-messages');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    connectWebSocket();
</script>
{% endblock %}

